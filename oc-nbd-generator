#!/bin/bash
# Copyright 2015 Emil Renner Berthing

set -e

. metadata

for i in $VOLUMES; do
  [[ "$i" != 0 ]] || continue

  tmp="VOLUMES_${i}_EXPORT_URI"
  tmp="${!tmp}"
  addr="${tmp#nbd://}"
  [[ "$tmp" != "$addr" ]] || continue

  port="${addr#*:}"
  addr="${addr%%:*}"
  cat > "$1/xnbd-client-nbd${i}.service" <<EOF
# Automatically generated by oc-nbd-generator

[Unit]
Description=xNBD client for /dev/nbd$i

[Service]
Type=forking
ExecStart=/usr/sbin/xnbd-client --blocksize 4096 --connect /dev/nbd$i $addr $port
ExecStartPost=/usr/sbin/udevadm trigger /dev/nbd$i
ExecStop=/usr/sbin/xnbd-client --disconnect /dev/nbd$i
EOF
  mkdir -m755 "$1/dev-nbd${i}.device.requires"
  ln -s "../xnbd-client-nbd${i}.service" "$1/dev-nbd${i}.device.requires/xnbd-client-nbd${i}.service"
done
